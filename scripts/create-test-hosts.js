module.exports = {


  friendlyName: 'Create test hosts',


  description: '',


  fn: async function () {

    sails.log('multiplying existing host records and vulnerable installs');

    // Goal of this:
    // Create 10k host records
    // Create AT least 10k vulnerability install records

    // Each host needs:
    // - fleetApid (unique)
    // - teamDisplayName
    // - teamApid
    // - vulnerabilities

    // Each VulnerabilityInstall needs:
    // - installedAt
    // - fleetApid (unique)
    // - vulnerability - ID of the vulnerbility record
    // - host - ID of the host record


    // get hosts
    //   - build new host records (hosts without the default added values)
    //   - build array of vulnerable installs - Problem: we need to add host ids to the vulnerable install records
    //   - 

    // create fake host records
    // Track created record ids



    // Get all host records w/ populated installs
    // Maybe stream with eachRecord()

    // Create an empty array to store the host records we're creating
    
    let vulnerableInstallByHostDisplayName = {};
    // Get an installedAt value we'll use for the vulnerability install records we will need to create.
    let installedAt = Date.now();

    // New goal: create 1,500,000 VulnerabilityInstall records
    // How? just create random records
    // pick random IDs
    // let installBatchSize = 100000;
    // let installGoalSize = 1500000;
    // let highestHostID = await Host.find().sort('id DESC').limit(1);
    // let maxHostID = highestHostID[0].id
    // let highestVulnerabilityID = await Vulnerability.find().sort('id DESC').limit(1);
    // let maxVulnID = highestVulnerabilityID[0].id


    // console.log(highestHostID)
    // console.log(highestVulnerabilityID)
    // await sails.helpers.flow.until( async ()=>{
    //   // find out how many records we'll need to make 
    //   let fakeInstallRecords = [];
    //   sails.log('Creating an array of test install records to create (Using randomly picked IDs for hosts and vulenrabilities)')
    //   await sails.helpers.flow.until( async()=>{

    //     let fakeInstallRecord = {
    //       installedAt: installedAt,
    //       uninstalledAt: 0,
    //       versionName: '0.0.0',
    //       softwareName: 'FAKE INSTALL',
    //       fleetApid: Math.floor(Math.random() * 999999) + 1,
    //       vulnerability: Math.floor(Math.random() * maxVulnID) + 1,
    //       host: Math.floor(Math.random() * maxHostID) + 1,
    //     }
    //     fakeInstallRecords.push(fakeInstallRecord);
    //     return fakeInstallRecords.length === installBatchSize;
    //   });

    //   sails.log(`Information for ${fakeInstallRecords.length} records has been created, saving results to DB...`)

    //   // await VulnerabilityInstall.createEach(fakeInstallRecords);

    //   // let installCount = await VulnerabilityInstall.count();
    //   console.log(`${installCount} total Installs!`);
    //   return installCount > installGoalSize;
    // })
      // let hostRecordWithHighestApid = await Host.find().sort('fleetApid DESC').limit(1);
      // let highestApid = hostRecordWithHighestApid[0].fleetApid;
      // sails.log('This will take a while………')
      // await Host.stream()
      // .populate('vulnerabilities')
      // .limit(554)
      // .skip(300)
      // .eachRecord( async(record)=>{
      //   let newTestHostRecord = _.omit(record, ['id', 'createdAt', 'updatedAt', 'vulnerabilities', 'fleetApid']);
      //   let newDisplayNameForThisHost = await sails.helpers.strings.random.with({len: 20});
      //   newTestHostRecord.displayName = newDisplayNameForThisHost
      //   highestApid++;
      //   newTestHostRecord.fleetApid = highestApid;
      //   hostRecordsToCreate.push(newTestHostRecord);
      //   let vulnerbleInstallsForThisNewHost = [];
      //   await VulnerabilityInstall.stream({
      //     where: {host: record.id},
      //   })
      //   // .limit(200)
      //   .eachRecord(async (record)=>{
      //     vulnerbleInstallsForThisNewHost.push(_.omit(record, ['id', 'createdAt', 'updatedAt', 'host']))
      //   })
      //   vulnerableInstallByHostDisplayName[newDisplayNameForThisHost] = vulnerbleInstallsForThisNewHost;
      // });

      // console.log(`Creating ${hostRecordsToCreate.length} host records`)
      // await sails.helpers.flow.simultaneouslyForEach(hostRecordsToCreate, async(host)=>{
      //   let newHostRecord = await Host.create(host).fetch();
      //   let newInstallRecordsToCreate = _.map(vulnerableInstallByHostDisplayName[newHostRecord.displayName], (install)=>{
      //     return { ...install, host:newHostRecord.id};
      //   })
      //   let newInstalls = await VulnerabilityInstall.createEach(newInstallRecordsToCreate).fetch();
      // });

      // let hostCount = await Host.count();
      // console.log(`${hostCount} total hosts!`);
    //   return hostCount > 10000;


    // console.log(vulnerableInstallByHostDisplayName);





  }


};

