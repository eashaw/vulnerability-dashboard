module.exports = {


  friendlyName: 'Download vulnerabilities csv',


  description: 'Download vulnerabilities csv file (returning a stream).',


  inputs: {

    minSeverity: {
      description: 'Optional filter to only get vulnerabilities whose `severity` is >= the specified value.',
      type: 'number',
      defaultsTo: 0,
    },

    maxSeverity: {
      description: 'Optional filter to only get vulnerabilities whose `severity` is <= the specified value.',
      type: 'number',
      defaultsTo: 10,
    },

    sortBy: {
      description: 'An optional facet to sort vulnerabilities by.',
      type: 'string',
      isIn: [
        'cveId',
        'severity',
        'hasKnownExploit',
        'publishedAt',
        'resolvedAt',
      ],
      defaultsTo: 'publishedAt'
    },

    sortDirection: {
      type: 'string',
      isIn: [
        'ASC',
        'DESC',
      ],
      defaultsTo: 'DESC'
    },

    page: {
      description: 'The zero-indexed page number.',
      type: 'number',
      defaultsTo: 0
    },

    teamApid: {
      description: 'The ID of the Team to filter by, or 0 to only include hosts with no team, or undefined to not filter by any team.',
      type: 'number',
    },

    pageSize: {
      description: 'The number of vulnerabilities to export',
      type: 'number',
      defaultsTo: 9999,
    },

    includeHostsAndSoftware: {
      description: 'If provided, additional rows will be added to the generated CSV for each affected host.',
      type: 'boolean',
    },

  },


  exits: {
    success: {
      outputFriendlyName: 'File',
      outputDescription: 'The streaming bytes of the file.',
      outputType: 'ref'
    },
    emptyExport: {
      description: 'No matching vulnerabilities could be found with the provided filters',
      responseType: 'notFound',
    }
  },


  fn: async function ({minSeverity, maxSeverity, sortBy, sortDirection, page, pageSize, teamApid, includeHostsAndSoftware}) {

    let report = await sails.helpers.getVulnerabilities.with({minSeverity, maxSeverity, sortBy, sortDirection, page, pageSize, teamApid})
    .intercept('noMatchingVulnerabilities', ()=>{
      return 'emptyExport';
    });

    let generatedCsv = 'CVE ID,Severity,Has known exploit,Publish date,Resolved Date,Number of affected hosts';

    if(includeHostsAndSoftware) {
      generatedCsv = 'CVE ID,Severity,Has known exploit,Publish date,Resolved Date,Affected software name,Affected software version,Affected software URL,Vulnerable software detected on,Host Fleet URL,Host display name,Host team,Host serial number,Host UUID,Host team ID';
    }

    generatedCsv += '\n';

    for(let vulnerability of report.entries) {
      let vulnString = `${vulnerability.cveId},${vulnerability.severity},${vulnerability.hasKnownExploit},${new Date(vulnerability.publishedAt)},${vulnerability.resolvedAt !== 0 ? new Date(vulnerability.resolvedAt) : 'N/A'},`;
      let strToAdd;
      if(!includeHostsAndSoftware) {
        strToAdd = vulnString + `${vulnerability.numAffectedHosts}\n`;
        generatedCsv += strToAdd;
      } else {
        for(let host of vulnerability.affectedHosts) {
          let installsForThisHost = _.where(vulnerability.affectedInstalls, {affectedHost: host.id});
          for(let install of installsForThisHost) {
            if(_.contains(install.version, ',')){
              sails.log.warn('Unexpected Data found during export: Detected install version contains a comma. Removing the comma to keep CSV formatting intact... Affected Install: ',install);
              install.version = install.version.replace(/,/g, '');
            }
            if(_.startsWith(install.version, ' ')|| _.endsWith(install.version, ' ')){
              sails.log.warn('Unexpected Data found during export: Install version has a trailing/leading space. Removing the whitespace to keep CSV formatting intact... Affected Install: ',install);
              install.version = _.trim(install.version);
            }
            if(_.startsWith(install.name, ' ')|| _.endsWith(install.name, ' ')){
              sails.log.warn('Unexpected Data found during export: Install name has a trailing/leading space. Removing the whitespace to keep CSV formatting intact... Affected Install: ',install);
              install.name = _.trim(install.name);
            }
            if(_.contains(install.name, ',')){
              sails.log.warn('Unexpected Data found during export: Detected install name containing a comma. Removing the commma to keep CSV formatting intact... Affected Install: ',install);
              install.name = install.name.replace(/,/g, '');
            }
            strToAdd = vulnString + `${install.name},${install.version},${install.url},${new Date(install.installedAt)},${sails.config.custom.fleetBaseUrl+'/hosts/'+encodeURIComponent(host.fleetApid)},${_.trim(host.displayName)},${host.teamDisplayName},${host.hardwareSerialNumber},${host.uuid},${host.teamApid !== 0 ? host.teamApid : 'N/A'}\n`;
            generatedCsv += strToAdd;
          }//∞
        }//∞
      }
    }//∞

    this.res.attachment(`export.csv`);
    this.res.set('text/csv');

    return generatedCsv;
  }


};
