module.exports = {


  friendlyName: 'Download one vulnerability CSV',


  description: 'Download a CSV containing information about a single vulnerability',


  inputs: {

    cveId: {
      decription: 'The CVE ID of the vulnerability that an CSV export will be created for.',
      type: 'string'
    }

  },


  exits: {
    success: {
      outputFriendlyName: 'File',
      outputDescription: 'The streaming bytes of the file.',
      outputType: 'ref'
    },
  },


  fn: async function ({cveId}) {
    let report = await sails.helpers.getVulnerabilities.with({cveId: cveId});

    let generatedCsv = 'CVE ID, Vulnerable software installed on, Host ID, Host display name, Host Fleet URL, Host team, Host team ID, Affected software name, Affected software version, Affected software URL \n';

    let thisVulnerability = report.entries[0];

    let installsForThisVulnerbility = await VulnerabilityInstall.find({vulnerability: thisVulnerability.id});

    for(let host of thisVulnerability.affectedHosts){
      let installForThisHost = _.find(installsForThisVulnerbility, {host: host.id});
      let strToAdd = `${thisVulnerability.cveId}, ${new Date(installForThisHost.installedAt)}, ${host.id}, ${host.displayName}, ${sails.config.custom.fleetBaseUrl+'/hosts/'+host.fleetApid}, ${host.teamDisplayName}, ${host.teamApid !== 99999 ? host.teamApid : 'N/A'}, ${installForThisHost.softwareName}, ${installForThisHost.versionName}, ${sails.config.custom.fleetBaseUrl+'/software/'+installForThisHost.fleetApid}`;
      strToAdd += '\n';
      generatedCsv += strToAdd;
    }


    this.res.attachment(`${cveId}.csv`);
    return this.res.set('text/csv').send(generatedCsv);
  }


};
