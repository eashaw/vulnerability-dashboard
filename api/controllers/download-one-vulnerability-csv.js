module.exports = {


  friendlyName: 'Download one vulnerability CSV',


  description: 'Download a CSV containing information about a single vulnerability',


  inputs: {

    cveId: {
      decription: 'The CVE ID of the vulnerability that an CSV export will be created for.',
      type: 'string'
    }

  },


  exits: {
    success: {
      outputFriendlyName: 'File',
      outputDescription: 'The streaming bytes of the file.',
      outputType: 'ref'
    },
  },


  fn: async function ({cveId}) {
    let report = await sails.helpers.getVulnerabilities.with({cveId: cveId});
    let installCount = 0;
    let generatedCsv = 'CVE ID,Severity,Has known exploit,Publish date,Vulnerable software detected on,Affected software name,Affected software version,Affected software URL,Host display name,Host Fleet URL,Host team,Host serial number,Host UUID,Host team ID\n';

    if(report.entries.length === 0) {
      throw new Error(`Unexpected error: When generating a CSV export for a single vulnerability (with the CVE id ${cveId}), the vulnerability was not found in the database.`);
    }
    let thisVulnerability = report.entries[0];

    for(let host of thisVulnerability.affectedHosts){
      let installsForThisHost = _.where(thisVulnerability.affectedInstalls, {affectedHost: host.id});
      let vulnString = `${thisVulnerability.cveId},${thisVulnerability.severity},${!!thisVulnerability.hasKnownExploit},${new Date(thisVulnerability.publishedAt)},`;
      for(let install of installsForThisHost) {
        if(_.contains(install.version, ',')){
          sails.log.warn('Unexpected Data found during export: Detected install version contains a comma. Removing the comma to keep CSV formatting intact... Affected Install: ',install);
          install.version = install.version.replace(/,/g, '');
        }
        if(_.startsWith(install.version, ' ')|| _.endsWith(install.version, ' ')){
          sails.log.warn('Unexpected Data found during export: Install version has a trailing/leading space. Removing the whitespace to keep CSV formatting intact... Affected Install: ',install);
          install.version = _.trim(install.version);
        }
        if(_.startsWith(install.name, ' ')|| _.endsWith(install.name, ' ')){
          sails.log.warn('Unexpected Data found during export: Install name has a trailing/leading space. Removing the whitespace to keep CSV formatting intact... Affected Install: ',install);
          install.name = _.trim(install.name);
        }
        if(_.contains(install.name, ',')){
          sails.log.warn('Unexpected Data found during export: Detected install name containing a comma. Removing the commma to keep CSV formatting intact... Affected Install: ',install);
          install.name = install.name.replace(/,/g, '');
        }
        let strToAdd = vulnString + `${install.name},${install.version},${install.url},${new Date(install.installedAt)},${sails.config.custom.fleetBaseUrl+'/hosts/'+encodeURIComponent(host.fleetApid)},${_.trim(host.displayName)},${host.teamDisplayName},${host.hardwareSerialNumber},${host.uuid},${host.teamApid !== 0 ? host.teamApid : 'N/A'}\n`;
        generatedCsv += strToAdd;
        installCount++
      }//âˆž
    }

    if(true) {
      let thisVulnerability = await Vulnerability.findOne({cveId: cveId});
      let numberOfInstallsForThisVuln = await VulnerabilityInstall.count({vulnerability: thisVulnerability.id});
      if(installCount !== numberOfInstallsForThisVuln){
        throw new Error('Something went wrong');
      }
    }


    let exportISOTimestamp = (new Date()).toISOString();

    this.res.attachment(`${cveId}-${exportISOTimestamp}.csv`);
    this.res.set('text/csv');
    return generatedCsv;
  }


};
