module.exports = {


  friendlyName: 'Download one vulnerability CSV',


  description: 'Download a CSV containing information about a single vulnerability',


  inputs: {

    cveId: {
      decription: 'The CVE ID of the vulnerability that an CSV export will be created for.',
      type: 'string'
    }

  },


  exits: {
    success: {
      outputFriendlyName: 'File',
      outputDescription: 'The streaming bytes of the file.',
      outputType: 'ref'
    },
  },


  fn: async function ({cveId}) {
    let report = await sails.helpers.getVulnerabilities.with({cveId: cveId});

    let generatedCsv = 'CVE ID, Vulnerable software installed on, Host display name, Host Fleet URL, Host team, Host team ID, Affected software name, Affected software version, Affected software URL \n';

    if(report.entries.length === 0) {
      throw new Error(`Unexpected error: When generating a CSV export for a single vulnerability (with the CVE id ${cveId}) was not found in the database.`);
    }
    let thisVulnerability = report.entries[0];

    let installsForThisVulnerability = await VulnerabilityInstall.find({vulnerability: thisVulnerability.id});

    for(let host of thisVulnerability.affectedHosts){
      let installForThisHost = _.find(installsForThisVulnerability, {host: host.id});
      let strToAdd = `${thisVulnerability.cveId}, ${new Date(installForThisHost.installedAt)}, ${host.displayName}, ${sails.config.custom.fleetBaseUrl+'/hosts/'+encodeURIComponent(host.fleetApid)}, ${host.teamDisplayName}, ${host.teamApid !== 0 ? host.teamApid : 'N/A'}, ${installForThisHost.softwareName}, ${installForThisHost.versionName}, ${sails.config.custom.fleetBaseUrl+'/software/'+encodeURIComponent(installForThisHost.fleetApid)}`;
      strToAdd += '\n';
      generatedCsv += strToAdd;
    }
    let exportISOTimestamp = (new Date()).toISOString();

    this.res.attachment(`${cveId}-${exportISOTimestamp}.csv`);
    this.res.set('text/csv');
    return generatedCsv;
  }


};
