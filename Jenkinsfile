#!/usr/bin/env groovy
@Library("pipeline@v2-stable")

def chartDir = 'helm'

fastlyPipeline(script: this) {
    echo env.BRANCH_IS_PRIMARY
    echo env.BRANCH_NAME

    if (env.BRANCH_NAME in ['main', 'origin/main']) {
        def fleetdm = [
            imageName: 'fastly/fleetdm',
            dockerFile: 'Dockerfile',
            cache: true,
            tagImage: 'v0.1',
            pushImage: true
        ]
    } else {
        def fleetdm = [
            imageName: 'fastly/fleetdm',
            dockerFile: 'Dockerfile',
            cache: true,
            tagImage: 'v0.1',
            pushImage: false //only lint
        ]
    }
    stage('Lint/Push Image') {
        fastlyPipeline(script: this) {
            fastlyDockerBuild(
            script:          this, // Object (required)
            containers:      [fleetdm], // List<Map> (required)
            parallelBuild:   true, // Boolean (optional), default: true
            checkout:        true, // Boolean (optional), default: true
            submodules:      false, // Boolean (optional), default: false
            loggerVerbosity: 'warn' // String (optional), default: 'warn'
            )
        }
    }
}
