<div id="vulnerability-list" v-cloak>

  <div class="container-fluid p-4">
    <div class="row">
      <div class="col-sm">
        <h3 purpose="page-heading">Vulnerabilities</h3>
        <!-- <label>Team to filter</label> -->
        <select class="custom-select team-select mx-2" v-model="teamApid" @change="changeFilteredTeam()">
          <option value="0" selected>All teams</option>
          <option v-for="option of teamsToDisplay" :value="option.id">{{option.name}}</option>
        </select>
        <a class="btn btn-small btn-outline" @click="clickOpenExportModal()">Export</a>
      </div>
      <div class="col-xs-4">
        <div class="form-inline d-flex justify-content-end">
          <label>CVSS score is between</label>
          <select class="custom-select mx-2" v-model="minSeverity" @change="changeMinSeverity()">
            <option v-for="option of severityFilterOptions" :value="option">{{option}}</option>
          </select>
          <label>and</label>
          <select class="custom-select mx-2" v-model="maxSeverity" @change="changeMaxSeverity()">
            <option v-for="option of severityFilterOptions" :value="option">{{option}}</option>
          </select>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-2 pb-2 pt-4 pt-sm-1" v-if="!cloudError && filteredVulnerabilities.length > 0">
        <p class="text-sm-left text-muted mb-sm-0 pt-sm-3">{{ (currentPageIndex * ENTRIES_PER_PAGE) + 1}}-{{Math.min((currentPageIndex * ENTRIES_PER_PAGE) + ENTRIES_PER_PAGE, totalFilteredVulnerabilities) }} of {{ totalFilteredVulnerabilities }}</p>
      </div>
    </div>
    <div class="mb-4 border rounded">
      <table class="table table-responsive-md my-0">
        <thead>
          <tr>
            <th>
              <span style="cursor: pointer;" @click="clickSortButton('cveId')">
                <small><strong>CVE ID</strong></small>
                <span class="d-inline-block p-1">
                  <span class="fa fa-caret-up" :class="sortBy === 'cveId' ? 'text-primary' : 'text-muted'" v-if="sortDirection === 'ASC' && sortBy === 'cveId'"></span>
                  <span class="fa fa-caret-down" :class="sortBy === 'cveId' ? 'text-primary' : 'text-muted'" v-else></span>
                </span>
              </span>
            </th>
            <th>
              <span style="cursor: pointer;" @click="clickSortButton('severity')">
                <small><strong>CVSS score</strong></small>
                <span class="d-inline-block p-1" style="cursor: pointer;" @click="clickSortButton('severity')">
                  <span class="fa fa-caret-up" :class="sortBy === 'severity' ? 'text-primary' : 'text-muted'" v-if="sortDirection === 'ASC' && sortBy === 'severity'"></span>
                  <span class="fa fa-caret-down" :class="sortBy === 'severity' ? 'text-primary' : 'text-muted'" v-else></span>
                </span>
              </span>
            </th>
            <th>
              <small><strong>Severity</strong></small>
              <span class="d-inline-block p-1"></span>
              <span class="d-inline-block p-1"><span class="fa fa-caret-down" style="opacity: 0"></span></span>
            </th>
            <th>
              <span style="cursor: pointer;" @click="clickSortButton('hasKnownExploit')">
                <small><strong>Exploit available</strong></small>
                <span class="d-inline-block p-1">
                  <span class="fa fa-caret-up" :class="sortBy === 'hasKnownExploit' ? 'text-primary' : 'text-muted'" v-if="sortDirection === 'ASC' && sortBy === 'hasKnownExploit'"></span>
                  <span class="fa fa-caret-down" :class="sortBy === 'hasKnownExploit' ? 'text-primary' : 'text-muted'" v-else></span>
                </span>
              </span>
            </th>
            <th>
              <small><strong>Total affected hosts</strong></small>
              <span class="d-inline-block p-1"><span class="fa fa-caret-down" style="opacity: 0"></span></span>
            </th>
            <th>
              <span style="cursor: pointer;" @click="clickSortButton('publishedAt')">
                <small><strong>Reported date</strong></small>
                <span class="d-inline-block p-1">
                  <span class="fa fa-caret-up" :class="sortBy === 'publishedAt' ? 'text-primary' : 'text-muted'" v-if="sortDirection === 'ASC' && sortBy === 'publishedAt'"></span>
                  <span class="fa fa-caret-down" :class="sortBy === 'publishedAt' ? 'text-primary' : 'text-muted'" v-else></span>
                </span>
              </span>
            </th>
            <th>
              <span><small><strong>Fix date</strong></small></span>
              <span class="d-inline p-1"><span class="fa fa-caret-down" style="opacity: 0"></span></span>
            </th>
            <th>
              <span><small><strong>Affected teams</strong></small></span>
              <span class="d-inline p-1"><span class="fa fa-caret-down" style="opacity: 0"></span></span>
            </th>
            <th>
              <span><small><strong>Affected software</strong></small></span>
              <span class="d-inline p-1"><span class="fa fa-caret-down" style="opacity: 0"></span></span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="vulnerability of filteredVulnerabilities" :key="vulnerability.id">
            <td><a target="_blank" :href="vulnerability.additionalDetailsUrl">{{vulnerability.cveId}}</a></td>
            <td>{{vulnerability.severity}}</td>
            <td>
              <span class="badge badge-dark" v-if="vulnerability.severity >= 9"><i class="fa fa-exclamation-triangle"></i> Critical</span>
              <span class="badge badge-danger" v-else-if="vulnerability.severity >= 7">High</span>
              <span class="badge badge-warning" v-else-if="vulnerability.severity >= 4">Medium</span>
              <span class="badge badge-secondary" v-else>Low</span>
            </td>
            <td>
              <span class="text-danger text-uppercase" v-if="vulnerability.hasKnownExploit">ðŸš¨ Exploit</span>
              <span class="text-muted" v-else>-</span>
            </td>
            <td>
            <a class="affected-host-link" @click="clickAffectedHosts(vulnerability)">{{vulnerability.numAffectedHosts}}</a>
            </td>
            <td>
              <js-timestamp :at="vulnerability.publishedAt" format="calendar"></js-timestamp>
            </td>
            <td>
              <js-timestamp :at="vulnerability.resolvedAt" format="calendar" v-if="vulnerability.resolvedAt"></js-timestamp>
              <span class="text-muted" v-else>-</span>
            </td>
            <td>
              <a class="affected-teams-link" v-if="vulnerability.affectedTeams">
                <span class="truncated-affected-tweets" v-if="vulnerability.affectedTeams.length > 1">
                  {{vulnerability.affectedTeams.length}} teams
                  <div class="teams-tooltip">
                    <p v-for="team in vulnerability.affectedTeams" @click="clickChangeAffectedTeam(team)">{{team}}</p>
                  </div>
                </span>
                <span v-else @click="clickChangeAffectedTeam(vulnerability.affectedTeams[0])">
                  {{vulnerability.affectedTeams[0]}}
                </span>
              </a>
              <p v-else>N/A</p>
            </td>
            <td>
              <span v-if="vulnerability.affectedSoftware">
                <span v-if="vulnerability.affectedSoftware.length > 1">
                  <a class="affected-host-link" @click="clickAffectedSoftware(vulnerability)">
                  {{vulnerability.affectedSoftware.length}} items
                  </a>
                </span>
                <span v-else>
                  <a :href="vulnerability.affectedSoftware[0].url">{{vulnerability.affectedSoftware[0].name}} @ {{vulnerability.affectedSoftware[0].version}}</a>
                </span>
              </span>
              <span v-else><strong>N/A</strong></span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <nav aria-label="vulnerability pages" v-if="!cloudError && pages.length > 1">
      <ul class="pagination justify-content-end">
        <li class="page-item" :class="currentPageIndex === 0? 'disabled' : ''">
          <a aria-label="Previous" class="page-link" @click="clickPageButton(currentPageIndex-1)"><i class="left-arrow"></i><span class="d-none d-md-inline">&nbsp;&nbsp;Previous</span></a>
        </li>
        <li class="page-item" :class="currentPageIndex+1 === page? 'active' : ''" v-for="page of pages">
          <a class="page-link disabled" v-if="page === '...'">{{page}}</a>
          <a class="page-link" @click="clickPageButton(page-1)" v-else>{{page}}</a>
        </li>
        <li class="page-item" :class="currentPageIndex === pages.indexOf(pages[pages.length-1])? 'disabled' : ''">
          <a aria-label="Next" class="page-link" @click="clickPageButton(currentPageIndex+1)"><span class="d-none d-md-inline">Next&nbsp;&nbsp;</span><i class="right-arrow"></i></a>
        </li>
      </ul>
    </nav>
  </div>

  <modal class="example-modal" v-if="modal==='remediation-details'" @opened="openedRemediationModal()" @close="closeModal()" v-cloak>
    <div class="modal-header">
      <h2 class="modal-title">{{selectedVulnerability.cveId}}</h2>
    </div>
    <div class="card-title">
      <p>Vulnerable hosts timeline</p>
    </div>
    <div class="modal-body">
      <canvas id="remediation-timeline"></canvas>
    </div>
    <div><p>Affected hosts <a style="cursor: pointer;" class="link ml-2" @click="clickExportOneCveCsv(selectedVulnerability.cveId)">Export CSV</a></p></div>
    <p v-if="teamApid !== 0">(Showing results for the {{teamNameByApid[teamApid]}} team.)</p>
    <div class="d-flex flex-row justify-content-between">
       <small class="text-muted pr-3">First reported: <js-timestamp :at="selectedVulnerability.createdAt"></js-timestamp></small>
    </div>
     <ul>
      <li v-for="host in affectedHostsForSelectedVuln">
        <a style="text-decoration: none" target="_blank" :href="fleetBaseUrl+'/hosts/'+host.fleetApid">{{host.displayName}}</a>
      </li>
     </ul>
   </modal>

  <modal class="example-modal" v-if="modal==='software-details'" @close="closeModal()" v-cloak>
     <div class="modal-header">
       <h2 class="modal-title">{{selectedVulnerability.cveId}}</h2>
     </div>
     <p>Affected software</p>
     <div class="d-flex flex-row justify-content-between">
       <small class="text-muted pr-3">First reported: <js-timestamp :at="selectedVulnerability.createdAt"></js-timestamp></small>
    </div>
     <ul>
      <li v-for="software in selectedVulnerability.affectedSoftware">
        <a style="text-decoration: none" target="_blank" :href="software.url">{{software.name}} @ {{software.version}}</a>
      </li>
     </ul>
   </modal>

  <modal class="example-modal" v-if="modal==='export-csv'" @close="closeModal()" v-cloak>
     <div class="modal-header">
       <h2 class="modal-title">Export vulnerabilities</h2>
     </div>
     <div class="modal-body">
      <ajax-form :handle-submitting="handleSubmittingExportForm" :syncing.sync="syncing" :cloud-error.sync="cloudError" :form-errors.sync="formErrors" :form-data="formData" :form-rules="formRules">
        <div class="form-group">
          <label for="team-name">Team</label>
          <select id="team-name" class="form-control" v-model="formData.teamApid">
            <option value="0" selected>All teams</option>
            <option v-for="option of teamsToDisplay" :value="option.id">{{option.name}}</option>
          </select>
        </div>
        <div class="row">
          <div class="form-group col-6">
          <label for="sort-by">Sort by value</label>
          <select id="sort-by" class="form-control" v-model="formData.sortBy">
            <option value="cveId" selected>CVE ID</option>
            <option value="severity">Severity</option>
            <option value="hasKnownExploit">hasKnownExploit</option>
            <option value="publishedAt" selected>Publish date</option>
            <option value="resolvedAt">Resolve date</option>
          </select>
          </div>
          <div class="form-group col-6">
            <label for="sort-direction">Sort direction</label>
            <select id="min-severity" class="custom-select" v-model="formData.sortDirection">
              <option value="ASC">Ascending</option>
              <option value="DESC" selected>Descending</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="export-min-severity">Min severity</label>
          <select id="export-min-severity" class="custom-select" v-model="formData.minSeverity">
            <option v-for="option of severityFilterOptions" :value="option">{{option}}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="export-max-severity">Max severity</label>
          <select id="export-max-severity" class="custom-select" v-model="formData.maxSeverity">
            <option v-for="option of severityFilterOptions" :value="option">{{option}}</option>
          </select>
        </div>
        <div class="d-flex flex-row justify-content-center">
        <div class="form-group pr-2">
          <label for="include-software">Include affected software?</label>
          <input id="include-software" type="checkbox" class="form-control" v-model="formData.includeSoftware">
        </div>
        <div class="form-group pl-2">
          <label for="include-hosts">Include affected hosts?</label>
          <input id="include-hosts" type="checkbox" class="form-control" v-model="formData.includeHosts">
        </div>
        </div>
        <cloud-error v-if="cloudError"></cloud-error>
        <div class="form-group">
          <ajax-button type="submit" :syncing="syncing" class="btn-light btn-lg btn-block">Export CSV</ajax-button>
        </div>
      </ajax-form>
     </div>
   </modal>

   <ajax-overlay :syncing="syncing"></ajax-overlay>
</div>
<%- /* Expose server-rendered data as window.SAILS_LOCALS :: */ exposeLocalsToBrowser() %>
